<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIY File Beam (Ludicrous)</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PeerJS for WebRTC connection -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        body {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); /* Amber for High Performance */
            min-height: 100vh;
        }
        /* Pulse animation for active transfer */
        @keyframes flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .transferring {
            background: linear-gradient(270deg, #f59e0b, #ef4444, #f59e0b);
            background-size: 200% 200%;
            animation: flow 2s ease infinite;
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <div class="glass-panel w-full max-w-md rounded-2xl p-6 transition-all duration-300">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-orange-100 text-orange-600 mb-4">
                <i class="fas fa-bolt text-3xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-800">File Beam <span class="text-orange-600">Ludicrous</span></h1>
            <p class="text-sm text-gray-500 mt-1">Zero-Latency Flow Control</p>
        </div>

        <!-- Connection Status -->
        <div id="status-panel" class="mb-6 bg-white rounded-xl p-4 border border-gray-100 shadow-sm">
            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Your Identity</p>
            <div class="flex items-center justify-between">
                <span id="my-id" class="text-lg font-mono font-bold text-orange-600 select-all">Generating...</span>
                <button onclick="copyId()" class="text-gray-400 hover:text-orange-600 transition-colors">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
            <p id="connection-status" class="text-xs mt-3 flex items-center text-amber-500">
                <span class="w-2 h-2 rounded-full bg-amber-500 mr-2 animate-pulse"></span>
                Waiting for connection...
            </p>
        </div>

        <!-- Tabs -->
        <div class="flex mb-6 bg-gray-100 p-1 rounded-lg">
            <button onclick="switchTab('send')" id="tab-send" class="flex-1 py-2 rounded-md text-sm font-medium bg-white shadow-sm text-gray-800 transition-all">Sender (Phone)</button>
            <button onclick="switchTab('receive')" id="tab-receive" class="flex-1 py-2 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 transition-all">Receiver (PC)</button>
        </div>

        <!-- Sender View -->
        <div id="view-send" class="block">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Connect to Receiver</label>
                    <div class="flex gap-2">
                        <input type="text" id="dest-id" placeholder="Enter PC's ID here" class="flex-1 rounded-lg border-gray-300 border p-2 text-sm focus:ring-2 focus:ring-orange-500 focus:outline-none uppercase">
                        <button onclick="connectToPeer()" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors">
                            <i class="fas fa-link"></i>
                        </button>
                    </div>
                </div>

                <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-orange-500 transition-colors cursor-pointer relative">
                    <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileSelect(this)">
                    <div id="drop-zone-text">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                        <p class="text-sm text-gray-500">Tap to select file</p>
                    </div>
                </div>
                
                <button onclick="startTransfer()" id="send-btn" class="w-full bg-gray-300 text-gray-500 font-bold py-3 rounded-xl cursor-not-allowed transition-all" disabled>
                    Start Ludicrous Transfer
                </button>
            </div>
        </div>

        <!-- Receiver View -->
        <div id="view-receive" class="hidden">
            <div class="text-center p-8 bg-gray-50 rounded-xl border border-gray-100">
                <div class="mb-4">
                    <i class="fas fa-satellite-dish text-4xl text-orange-300"></i>
                </div>
                <h3 class="font-bold text-gray-800 mb-2">Ready to Receive</h3>
                <p class="text-sm text-gray-500 mb-4">Share your ID above with the sender.</p>
                <div id="fs-warning" class="hidden text-xs text-green-600 bg-green-50 p-2 rounded border border-green-100">
                    <i class="fas fa-check-circle mr-1"></i> Fast Disk Write Active
                </div>
            </div>
        </div>

        <!-- Progress Overlay -->
        <div id="progress-panel" class="hidden mt-6">
            <div class="flex justify-between text-sm mb-1">
                <span class="font-medium text-gray-700" id="progress-text">Transferring...</span>
                <span class="font-bold text-orange-600" id="progress-percent">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                <div id="progress-bar" class="bg-orange-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="speed-text" class="text-xs text-gray-500 mt-2 text-right font-mono">0.0 MB/s</p>
        </div>

    </div>

    <script>
        // --- Logic & State ---
        let peer = null;
        let conn = null;
        let myId = '';
        let selectedFile = null;
        let fileHandle = null;
        let writableStream = null;
        
        // Speed Calculation vars
        let lastTime = Date.now();
        let lastOffset = 0;
        
        // PeerJS Configuration
        const peerConfig = { debug: 1 };

        // Initialize Peer
        function init() {
            const shortId = Math.random().toString(36).substring(2, 6).toUpperCase();
            peer = new Peer(shortId, peerConfig);

            peer.on('open', (id) => {
                myId = id;
                document.getElementById('my-id').innerText = id;
            });

            peer.on('connection', (connection) => {
                handleConnection(connection);
            });

            peer.on('error', (err) => {
                console.error(err);
                alert("Connection Error: " + err.type);
            });

            if ('showSaveFilePicker' in window) {
                document.getElementById('fs-warning').classList.remove('hidden');
            }
        }

        // --- Connection Handling ---
        function connectToPeer() {
            const destId = document.getElementById('dest-id').value.toUpperCase();
            if (!destId) return alert("Please enter the ID");
            
            setStatus("Connecting to " + destId + "...", "amber");
            conn = peer.connect(destId, { reliable: true }); // Ensure reliable
            handleConnection(conn);
        }

        function handleConnection(connection) {
            conn = connection;
            
            conn.on('open', () => {
                setStatus("Connected securely!", "green");
                document.getElementById('connection-status').innerHTML = 
                    `<span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span> Connected`;
            });

            conn.on('data', async (data) => {
                handleIncomingData(data);
            });

            conn.on('close', () => {
                setStatus("Disconnected", "red");
                endTransfer();
            });
        }

        // --- Optimized File Sending Logic ---
        
        // Helper: Promisified FileReader for clean async loops
        function readChunk(file, offset, length) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsArrayBuffer(file.slice(offset, offset + length));
            });
        }

        function handleFileSelect(input) {
            if (input.files.length > 0) {
                selectedFile = input.files[0];
                document.getElementById('drop-zone-text').innerHTML = 
                    `<i class="fas fa-file-video text-3xl text-orange-500 mb-2"></i>
                     <p class="text-sm font-bold text-gray-700">${selectedFile.name}</p>
                     <p class="text-xs text-gray-500">${(selectedFile.size / (1024*1024*1024)).toFixed(2)} GB</p>`;
                
                const btn = document.getElementById('send-btn');
                btn.disabled = false;
                btn.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                btn.classList.add('bg-orange-600', 'text-white', 'hover:bg-orange-700');
            }
        }

        async function startTransfer() {
            if (!conn || !conn.open) return alert("Not connected to Receiver!");
            if (!selectedFile) return;

            // 1. Send Metadata
            conn.send({
                type: 'metadata',
                name: selectedFile.name,
                size: selectedFile.size,
                mime: selectedFile.type
            });

            document.getElementById('progress-panel').classList.remove('hidden');
            document.getElementById('progress-bar').classList.add('transferring');
            
            // --- LUDICROUS MODE SETTINGS ---
            // 64KB is often the optimal spot for Chrome's internal DataChannel fragmentation
            const CHUNK_SIZE = 64 * 1024; 
            // 16MB Buffer - Keep pipe full but don't crash browser
            const MAX_BUFFER = 16 * 1024 * 1024; 
            
            let offset = 0;
            
            // Reset speed calc
            lastTime = Date.now();
            lastOffset = 0;

            // 2. Optimized Loop
            while (offset < selectedFile.size) {
                
                // CRITICAL: Non-blocking Flow Control
                // We pause ONLY if buffer is full, otherwise we push hard.
                if (conn.dataChannel.bufferedAmount > MAX_BUFFER) {
                    // Wait for next tick (0ms) instead of 10ms.
                    // This allows the event loop to clear the buffer instantly.
                    await new Promise(r => setTimeout(r, 0)); 
                    continue; 
                }

                const chunk = await readChunk(selectedFile, offset, CHUNK_SIZE);
                
                conn.send({
                    type: 'chunk',
                    data: chunk
                });

                offset += chunk.byteLength;
                
                // Throttle UI updates to save CPU for transfer
                // Only update every ~1MB
                if (offset % (1024*1024) < CHUNK_SIZE) {
                    updateProgress(offset, selectedFile.size);
                }
            }
            
            updateProgress(selectedFile.size, selectedFile.size);
            conn.send({ type: 'end' });
            document.getElementById('progress-bar').classList.remove('transferring');
            setStatus("Transfer Complete", "green");
        }

        // --- File Receiving Logic ---
        let receivedSize = 0;
        let totalSize = 0;
        let incomingFileName = "";
        let receiveBuffer = [];

        async function handleIncomingData(data) {
            if (data.type === 'metadata') {
                totalSize = data.size;
                incomingFileName = data.name;
                receivedSize = 0;
                receiveBuffer = [];
                lastTime = Date.now();
                lastOffset = 0;
                
                document.getElementById('progress-panel').classList.remove('hidden');
                document.getElementById('progress-bar').classList.add('transferring');
                document.getElementById('progress-text').innerText = `Receiving: ${data.name}`;

                if ('showSaveFilePicker' in window) {
                    try {
                        fileHandle = await window.showSaveFilePicker({
                            suggestedName: data.name
                        });
                        writableStream = await fileHandle.createWritable();
                    } catch (err) {
                        console.log("File save cancelled or API not supported.");
                    }
                }

            } else if (data.type === 'chunk') {
                receivedSize += data.data.byteLength;
                
                if (receivedSize % (1024*1024) < 64*1024) {
                     updateProgress(receivedSize, totalSize);
                }

                if (writableStream) {
                    await writableStream.write(data.data);
                } else {
                    receiveBuffer.push(data.data);
                }

            } else if (data.type === 'end') {
                updateProgress(totalSize, totalSize);
                document.getElementById('progress-bar').classList.remove('transferring');
                
                if (writableStream) {
                    await writableStream.close();
                    alert("File Saved Successfully!");
                } else {
                    const blob = new Blob(receiveBuffer);
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = incomingFileName;
                    a.click();
                }
                resetTransfer();
            }
        }

        // --- UI Utilities ---
        function switchTab(tab) {
            document.getElementById('tab-send').className = tab === 'send' 
                ? "flex-1 py-2 rounded-md text-sm font-medium bg-white shadow-sm text-gray-800 transition-all"
                : "flex-1 py-2 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 transition-all";
            
            document.getElementById('tab-receive').className = tab === 'receive' 
                ? "flex-1 py-2 rounded-md text-sm font-medium bg-white shadow-sm text-gray-800 transition-all"
                : "flex-1 py-2 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 transition-all";

            document.getElementById('view-send').className = tab === 'send' ? "block" : "hidden";
            document.getElementById('view-receive').className = tab === 'receive' ? "block" : "hidden";
        }

        function updateProgress(current, total) {
            const percent = Math.round((current / total) * 100);
            document.getElementById('progress-bar').style.width = percent + "%";
            document.getElementById('progress-percent').innerText = percent + "%";
            
            // Calculate Speed
            const now = Date.now();
            const timeDiff = now - lastTime;
            
            if (timeDiff > 1000) {
                const bytesDiff = current - lastOffset;
                const speedBps = (bytesDiff / timeDiff) * 1000;
                const speedMBps = (speedBps / (1024 * 1024)).toFixed(1);
                
                document.getElementById('speed-text').innerText = `${speedMBps} MB/s`;
                
                lastTime = now;
                lastOffset = current;
            }
        }

        function copyId() {
            navigator.clipboard.writeText(myId);
            alert("ID Copied!");
        }

        function setStatus(msg, color) {
            console.log(msg);
        }

        function resetTransfer() {
            setTimeout(() => {
                document.getElementById('progress-panel').classList.add('hidden');
                document.getElementById('progress-bar').style.width = "0%";
            }, 3000);
            writableStream = null;
            receiveBuffer = [];
        }

        // Start App
        init();
    </script>
</body>
</html>
