<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIY File Beam (Adaptive)</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PeerJS for WebRTC connection -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        body {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); /* Blue for Professional/Stable */
            min-height: 100vh;
        }
        /* Pulse animation for active transfer */
        @keyframes flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .transferring {
            background: linear-gradient(270deg, #3b82f6, #60a5fa, #3b82f6);
            background-size: 200% 200%;
            animation: flow 2s ease infinite;
        }
        .gear-indicator {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <div class="glass-panel w-full max-w-md rounded-2xl p-6 transition-all duration-300">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-100 text-blue-600 mb-4">
                <i class="fas fa-cogs text-3xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-800">File Beam <span class="text-blue-600">Adaptive</span></h1>
            <p class="text-sm text-gray-500 mt-1">Auto-Gearing for Max Speed</p>
        </div>

        <!-- Connection Status -->
        <div id="status-panel" class="mb-6 bg-white rounded-xl p-4 border border-gray-100 shadow-sm">
            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Your Identity</p>
            <div class="flex items-center justify-between">
                <span id="my-id" class="text-lg font-mono font-bold text-blue-600 select-all">Generating...</span>
                <button onclick="copyId()" class="text-gray-400 hover:text-blue-600 transition-colors">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
            <p id="connection-status" class="text-xs mt-3 flex items-center text-amber-500">
                <span class="w-2 h-2 rounded-full bg-amber-500 mr-2 animate-pulse"></span>
                Waiting for connection...
            </p>
        </div>

        <!-- Tabs -->
        <div class="flex mb-6 bg-gray-100 p-1 rounded-lg">
            <button onclick="switchTab('send')" id="tab-send" class="flex-1 py-2 rounded-md text-sm font-medium bg-white shadow-sm text-gray-800 transition-all">Sender (Phone)</button>
            <button onclick="switchTab('receive')" id="tab-receive" class="flex-1 py-2 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 transition-all">Receiver (PC)</button>
        </div>

        <!-- Sender View -->
        <div id="view-send" class="block">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Connect to Receiver</label>
                    <div class="flex gap-2">
                        <input type="text" id="dest-id" placeholder="Enter PC's ID here" class="flex-1 rounded-lg border-gray-300 border p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none uppercase">
                        <button onclick="connectToPeer()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-link"></i>
                        </button>
                    </div>
                </div>

                <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-blue-500 transition-colors cursor-pointer relative">
                    <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileSelect(this)">
                    <div id="drop-zone-text">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                        <p class="text-sm text-gray-500">Tap to select file</p>
                    </div>
                </div>
                
                <div id="action-area">
                    <button onclick="startTransfer()" id="send-btn" class="w-full bg-gray-300 text-gray-500 font-bold py-3 rounded-xl cursor-not-allowed transition-all" disabled>
                        Start Adaptive Transfer
                    </button>
                </div>
            </div>
        </div>

        <!-- Receiver View -->
        <div id="view-receive" class="hidden">
            <div class="text-center p-8 bg-gray-50 rounded-xl border border-gray-100">
                <div class="mb-4">
                    <i class="fas fa-satellite-dish text-4xl text-blue-300"></i>
                </div>
                <h3 class="font-bold text-gray-800 mb-2">Ready to Receive</h3>
                <p class="text-sm text-gray-500 mb-4">Share your ID above with the sender.</p>
                <div id="fs-warning" class="hidden text-xs text-green-600 bg-green-50 p-2 rounded border border-green-100">
                    <i class="fas fa-check-circle mr-1"></i> Fast Disk Write Active
                </div>
            </div>
        </div>

        <!-- Progress Overlay -->
        <div id="progress-panel" class="hidden mt-6">
            <div class="flex justify-between text-sm mb-1">
                <span class="font-medium text-gray-700" id="progress-text">Transferring...</span>
                <span class="font-bold text-blue-600" id="progress-percent">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div class="flex justify-between items-center mt-2">
                <div class="flex items-center space-x-2 text-xs text-gray-500">
                    <i class="fas fa-tachometer-alt"></i>
                    <span id="gear-text" class="gear-indicator font-mono">Gear 1 (64KB)</span>
                </div>
                <p id="speed-text" class="text-xs text-gray-500 font-mono text-right">0.0 MB/s</p>
            </div>
        </div>

    </div>

    <script>
        // --- Logic & State ---
        let peer = null;
        let conn = null;
        let myId = '';
        let selectedFile = null;
        let fileHandle = null;
        let writableStream = null;
        let transferActive = false;
        
        // Speed Calculation vars
        let lastTime = Date.now();
        let lastOffset = 0;
        
        // PeerJS Configuration
        const peerConfig = { debug: 1 };

        // Initialize Peer
        function init() {
            const shortId = Math.random().toString(36).substring(2, 6).toUpperCase();
            peer = new Peer(shortId, peerConfig);

            peer.on('open', (id) => {
                myId = id;
                document.getElementById('my-id').innerText = id;
            });

            peer.on('connection', (connection) => {
                handleConnection(connection);
            });

            peer.on('error', (err) => {
                console.error(err);
                alert("Connection Error: " + err.type);
            });

            if ('showSaveFilePicker' in window) {
                document.getElementById('fs-warning').classList.remove('hidden');
            }
        }

        // --- Connection Handling ---
        function connectToPeer() {
            const destId = document.getElementById('dest-id').value.toUpperCase();
            if (!destId) return alert("Please enter the ID");
            
            setStatus("Connecting to " + destId + "...", "amber");
            conn = peer.connect(destId, { reliable: true });
            handleConnection(conn);
        }

        function handleConnection(connection) {
            conn = connection;
            
            conn.on('open', () => {
                setStatus("Connected securely!", "green");
                document.getElementById('connection-status').innerHTML = 
                    `<span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span> Connected`;
            });

            conn.on('data', async (data) => {
                handleIncomingData(data);
            });

            conn.on('close', () => {
                setStatus("Disconnected", "red");
                if(transferActive) cancelTransfer();
            });
        }

        // --- Optimized File Sending Logic ---
        
        function readChunk(file, offset, length) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => resolve(null); // Handle error
                reader.readAsArrayBuffer(file.slice(offset, offset + length));
            });
        }

        function handleFileSelect(input) {
            if (input.files.length > 0) {
                selectedFile = input.files[0];
                document.getElementById('drop-zone-text').innerHTML = 
                    `<i class="fas fa-file-video text-3xl text-blue-500 mb-2"></i>
                     <p class="text-sm font-bold text-gray-700">${selectedFile.name}</p>
                     <p class="text-xs text-gray-500">${(selectedFile.size / (1024*1024*1024)).toFixed(2)} GB</p>`;
                
                const btn = document.getElementById('send-btn');
                btn.disabled = false;
                btn.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                btn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
            }
        }

        function cancelTransfer() {
            transferActive = false;
            // Send cancel signal
            if (conn && conn.open) {
                conn.send({ type: 'cancel' });
            }
            resetTransferUI();
            alert("Transfer Cancelled");
        }

        async function startTransfer() {
            if (!conn || !conn.open) return alert("Not connected to Receiver!");
            if (!selectedFile) return;

            // Swap Send button for Cancel button
            const actionArea = document.getElementById('action-area');
            actionArea.innerHTML = `
                <button onclick="cancelTransfer()" class="w-full bg-red-500 text-white font-bold py-3 rounded-xl hover:bg-red-600 transition-all shadow-md">
                    <i class="fas fa-stop-circle mr-2"></i> Stop Transfer
                </button>
            `;

            // 1. Send Metadata
            conn.send({
                type: 'metadata',
                name: selectedFile.name,
                size: selectedFile.size,
                mime: selectedFile.type
            });

            document.getElementById('progress-panel').classList.remove('hidden');
            document.getElementById('progress-bar').classList.add('transferring');
            
            transferActive = true;

            // --- ADAPTIVE GEAR SYSTEM ---
            // Gears: 1=32KB, 2=64KB, 3=128KB, 4=256KB, 5=512KB
            const GEARS = [32*1024, 64*1024, 128*1024, 256*1024, 512*1024];
            let currentGearIndex = 1; // Start at 64KB (Gear 2)
            let chunkSize = GEARS[currentGearIndex]; 
            const MAX_BUFFER = 16 * 1024 * 1024; // 16MB Safe Limit

            let offset = 0;
            lastTime = Date.now();
            lastOffset = 0;
            let chunksSentSinceCheck = 0;

            // 2. Loop
            while (offset < selectedFile.size && transferActive) {
                
                // Flow Control: If buffer is too full, wait
                if (conn.dataChannel.bufferedAmount > MAX_BUFFER) {
                    await new Promise(r => setTimeout(r, 10)); // Breather
                    
                    // Downshift if we are choking (buffer staying full)
                    if (currentGearIndex > 0 && Math.random() > 0.8) { // 20% chance to downshift on choke
                        currentGearIndex--;
                        chunkSize = GEARS[currentGearIndex];
                        updateGearUI(currentGearIndex, chunkSize);
                    }
                    continue; 
                }

                // If buffer is empty, we might be going too slow -> Upshift!
                if (conn.dataChannel.bufferedAmount === 0 && currentGearIndex < GEARS.length - 1) {
                     // Only upshift occasionally to check stability
                     if (chunksSentSinceCheck > 20) {
                        currentGearIndex++;
                        chunkSize = GEARS[currentGearIndex];
                        updateGearUI(currentGearIndex, chunkSize);
                        chunksSentSinceCheck = 0;
                     }
                }

                const chunk = await readChunk(selectedFile, offset, chunkSize);
                if (!chunk) break; // Error reading

                conn.send({
                    type: 'chunk',
                    data: chunk
                });

                offset += chunk.byteLength;
                chunksSentSinceCheck++;
                
                // Throttle UI updates
                if (chunksSentSinceCheck % 5 === 0) {
                    updateProgress(offset, selectedFile.size);
                }
            }
            
            if (transferActive) {
                updateProgress(selectedFile.size, selectedFile.size);
                conn.send({ type: 'end' });
                setStatus("Transfer Complete", "green");
                resetTransferUI();
            }
        }

        // --- File Receiving Logic ---
        let receivedSize = 0;
        let totalSize = 0;
        let incomingFileName = "";
        let receiveBuffer = [];

        async function handleIncomingData(data) {
            if (data.type === 'metadata') {
                totalSize = data.size;
                incomingFileName = data.name;
                receivedSize = 0;
                receiveBuffer = [];
                lastTime = Date.now();
                lastOffset = 0;
                transferActive = true;
                
                document.getElementById('progress-panel').classList.remove('hidden');
                document.getElementById('progress-bar').classList.add('transferring');
                document.getElementById('progress-text').innerText = `Receiving: ${data.name}`;

                if ('showSaveFilePicker' in window) {
                    try {
                        fileHandle = await window.showSaveFilePicker({
                            suggestedName: data.name
                        });
                        writableStream = await fileHandle.createWritable();
                    } catch (err) {
                        console.log("File save cancelled.");
                        conn.send({type: 'cancel'}); // Notify sender
                        resetTransferUI();
                    }
                }

            } else if (data.type === 'chunk' && transferActive) {
                receivedSize += data.data.byteLength;
                
                if (receivedSize % (256*1024) < 64*1024) { // Throttle receiver UI
                     updateProgress(receivedSize, totalSize);
                }

                if (writableStream) {
                    await writableStream.write(data.data);
                } else {
                    receiveBuffer.push(data.data);
                }

            } else if (data.type === 'end') {
                updateProgress(totalSize, totalSize);
                finishReceive();
            } else if (data.type === 'cancel') {
                alert("Sender cancelled the transfer.");
                if (writableStream) await writableStream.abort();
                resetTransferUI();
            }
        }

        async function finishReceive() {
            document.getElementById('progress-bar').classList.remove('transferring');
            if (writableStream) {
                await writableStream.close();
                alert("File Saved Successfully!");
            } else {
                const blob = new Blob(receiveBuffer);
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = incomingFileName;
                a.click();
            }
            resetTransferUI();
        }

        // --- UI Utilities ---
        function resetTransferUI() {
            transferActive = false;
            document.getElementById('action-area').innerHTML = `
                <button onclick="startTransfer()" id="send-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition-all">
                    Start Adaptive Transfer
                </button>
            `;
            setTimeout(() => {
                document.getElementById('progress-panel').classList.add('hidden');
                document.getElementById('progress-bar').style.width = "0%";
            }, 2000);
            writableStream = null;
            receiveBuffer = [];
        }

        function updateGearUI(index, size) {
            const kb = Math.round(size/1024);
            const el = document.getElementById('gear-text');
            el.innerText = `Gear ${index+1} (${kb}KB)`;
            
            // Visual flair for high gears
            if (index >= 3) el.className = "gear-indicator font-mono font-bold text-blue-600";
            else el.className = "gear-indicator font-mono text-gray-500";
        }

        function switchTab(tab) {
            document.getElementById('tab-send').className = tab === 'send' 
                ? "flex-1 py-2 rounded-md text-sm font-medium bg-white shadow-sm text-gray-800 transition-all"
                : "flex-1 py-2 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 transition-all";
            
            document.getElementById('tab-receive').className = tab === 'receive' 
                ? "flex-1 py-2 rounded-md text-sm font-medium bg-white shadow-sm text-gray-800 transition-all"
                : "flex-1 py-2 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 transition-all";

            document.getElementById('view-send').className = tab === 'send' ? "block" : "hidden";
            document.getElementById('view-receive').className = tab === 'receive' ? "block" : "hidden";
        }

        function updateProgress(current, total) {
            const percent = Math.round((current / total) * 100);
            document.getElementById('progress-bar').style.width = percent + "%";
            document.getElementById('progress-percent').innerText = percent + "%";
            
            const now = Date.now();
            const timeDiff = now - lastTime;
            
            if (timeDiff > 1000) {
                const bytesDiff = current - lastOffset;
                const speedBps = (bytesDiff / timeDiff) * 1000;
                const speedMBps = (speedBps / (1024 * 1024)).toFixed(1);
                
                document.getElementById('speed-text').innerText = `${speedMBps} MB/s`;
                
                lastTime = now;
                lastOffset = current;
            }
        }

        function copyId() {
            navigator.clipboard.writeText(myId);
            alert("ID Copied!");
        }

        function setStatus(msg, color) {
            console.log(msg);
        }

        // Start App
        init();
    </script>
</body>
</html>
